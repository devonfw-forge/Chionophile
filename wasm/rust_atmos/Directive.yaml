# the Directive is a complete description of your application, including all of its business logic.
# appVersion should be updated for each new deployment of your app.
# atmoVersion declares which version of Atmo is used for the `subo dev` command.

identifier: com.suborbital.rust_wasm
appVersion: v0.1.0
atmoVersion: v0.4.7

connections:
  database:
    type: postgresql
    connectionString: postgresql://jtq_user:admin@jtq_postgres_intern:5432/jtq_db

queries:
  - name: "SelectVisitor"
    query: |-
      SELECT * FROM visitor
      WHERE id = $1

  - name: "SelectAccessCode"
    query: |-
      SELECT * FROM accesscode
      WHERE id = $1

  - name: "InsertAccessCode"
    query: |-
      INSERT INTO 
      AccessCode (modificationCounter, creationTime, startTime, endTime, idVisitor, idQueue) 
      VALUES 
      ( 1, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, NULL, $1, $2)
      RETURNING *

  - name: "DeleteAccessCode"
    query: |-
      DELETE FROM accesscode WHERE id=$1

  - name: "SearchAccessCode"
    query: |-
      SELECT * FROM accesscode


handlers:
  - type: request
    resource: /jumpthequeue/services/rest/visitor/:id/
    method: GET
    steps:
      - fn: GetVisitor

  - type: request
    resource: /jumpthequeue/services/rest/accesscodemanagement/v1/accesscode/
    method: POST
    steps:
      - fn: AssociateAccessCode

  - type: request
    resource: /jumpthequeue/services/rest/accesscodemanagement/v1/accesscode/:id/
    method: GET
    steps:
      - fn: GetAccessCode

  - type: request
    resource: /jumpthequeue/services/rest/accesscodemanagement/v1/accesscode/cto/search/
    method: POST
    steps:
      - fn: SearchAccessCode

  - type: request
    resource: /jumpthequeue/services/rest/accesscodemanagement/v1/accesscode/:id/
    method: DELETE
    steps:
      - fn: DeleteAccessCode
