# the Directive is a complete description of your application, including all of its business logic.
# appVersion should be updated for each new deployment of your app.
# atmoVersion declares which version of Atmo is used for the `subo dev` command.

identifier: com.suborbital.rust_wasm
appVersion: v0.1.0
atmoVersion: v0.4.7

connections:
  database:
    type: postgresql
    connectionString: postgresql://jtq_user:admin@jtq_postgres_intern:5432/jtq_db

queries:
  - name: "SelectVisitor"
    query: |-
      SELECT * FROM visitor
      WHERE id = $1
  - name: "DeleteVisitor"
    query: |-
      DELETE FROM visitor
      WHERE id = $1
  - name: "DeleteAccessCodeByIdVisitor"
    query: |-
      DELETE FROM accesscode
      WHERE idVisitor = $1
  - name: "CreateVisitor"
    query: |-
      INSERT INTO visitor(acceptedcommercial, acceptedterms, modificationcounter, name, 
          password, phonenumber, username, usertype)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
      RETURNING id
  - name: "SelectLastIdVisitor"
    query: |-
      SELECT currval('visitor_id_seq');
  - name: "SearchVisitor"
    query: |- 
        SELECT * FROM visitor
  - name: "SearchVisitorWithParams"
    query: |- 
      SELECT * FROM VISITOR
      WHERE visitor.username = $1
      AND visitor.password = $2
  
  #################################33
  # QUEUE:
  - name: "SelectQueue"
    query: |-
      SELECT * FROM dailyqueue
      WHERE id = $1

  - name: "DeleteQueue"
    query: |-
      DELETE FROM dailyqueue WHERE id = $1
      
  - name: "DeleteACQueue"
    query: |-
      DELETE FROM accesscode WHERE idqueue = $1

  - name: "CreateQueue"
    query: |-
      INSERT INTO dailyqueue(modificationcounter, name, logo, currentnumber, 
        attentiontime, minattentiontime, active)
      VALUES ($1, $2, $3, $4, $5, $6, $7)
      RETURNING id
  
  - name: "SelectLastIdQueue"
    query: |-
      SELECT currval('dailyqueue_id_seq');

  - name: "SearchQueue"
    query: |- 
        SELECT * FROM dailyqueue

  - name: "SearchQueueActive"
    query: |- 
        SELECT * FROM dailyqueue
        WHERE active=$1

handlers:
  - type: request
    resource: /jumpthequeue/services/rest/visitormanagement/v1/visitor/:id/
    method: GET
    steps:
      - fn: GetVisitor
  - type: request
    resource: /jumpthequeue/services/rest/visitormanagement/v1/visitor/:id/
    method: DELETE
    steps:
      - fn: DeleteVisitor
  - type: request
    resource: /jumpthequeue/services/rest/visitormanagement/v1/visitor/
    method: POST
    steps:
      - fn: CreateVisitor
  - type: request
    resource: /jumpthequeue/services/rest/visitormanagement/v1/visitor/search/
    method: POST
    steps:
      - fn: SearchVisitor
      
  #################################33
  # QUEUE:
  - type: request
    resource: /jumpthequeue/services/rest/queuemanagement/v1/queue/:id/
    method: GET
    steps:
      - fn: GetQueue

  - type: request
    resource: /jumpthequeue/services/rest/queuemanagement/v1/queue/
    method: POST
    steps:
      - fn: CreateQueue

  - type: request
    resource: /jumpthequeue/services/rest/queuemanagement/v1/queue/:id/
    method: DELETE
    steps:
      - fn: DeleteQueue
      
  - type: request
    resource: /jumpthequeue/services/rest/queuemanagement/v1/queue/search/
    method: POST
    steps:
      - fn: SearchQueue

